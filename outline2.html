<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Screenplay Notecard Board</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

:root{
  --bg-0: #0b1220;
  --bg-1: #0f172a;
  --bg-2: #111827;
  --bg-3: #1f2937;
  --text-0: #e5e7eb;
  --text-1: #cbd5e1;
  --text-2: #94a3b8;
  --muted: #334155;
  --muted-2: #374151;
  --brand: #10b981;
  --brand-2: #059669;
  --danger-bg: #7f1d1d;
  --danger-border: #ef4444;
  --danger-text: #fecaca;
  --placeholder: #6b7280;

  --marker-bg: rgba(16,185,129,.14);
  --marker-border: #10b981;
  --marker-pill-bg: rgba(16,185,129,.2);
  --marker-pill-text: #a7f3d0;
  --marker-pill-border: rgba(16,185,129,.4);
}

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: radial-gradient(1200px 600px at 20% 0%, #0d1630 0%, var(--bg-0) 50%) fixed,
              linear-gradient(135deg, var(--bg-0) 0%, #0c1326 100%) fixed;
  color: var(--text-0);
  min-height: 100vh;
  padding: 20px;
}

.container { max-width: 1200px; margin: 0 auto; }

.top-sticky {
  position: sticky; top: 0; z-index: 100;
  background: linear-gradient(180deg, rgba(11,18,32,.96), rgba(11,18,32,.92));
  backdrop-filter: blur(6px);
  border-bottom: 1px solid var(--muted);
  padding-bottom: 8px; margin-bottom: 12px;
}

.header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; gap: 16px; }
.header h1 { font-size: 1.8rem; color: var(--text-0); margin-bottom: 6px; }
.header p { color: var(--text-2); font-size: 0.95rem; }

.header-actions { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: flex-end; }

.project-title, .cols-input, .type-select, .text-input {
  padding: 10px; border: 2px solid var(--muted); border-radius: 8px;
  font-size: 14px; background: var(--bg-2); color: var(--text-0);
}
.project-title::placeholder{ color: var(--placeholder); }

.cols-wrapper, .type-wrapper {
  display: inline-flex; align-items: center; gap: 8px; color: var(--text-1); font-size: 14px;
  background: var(--bg-2); border: 2px solid var(--muted); border-radius: 8px; padding: 8px 10px;
}
.cols-input { width: 70px; text-align: center; }

.controls { display: flex; gap: 12px; margin-bottom: 10px; align-items: flex-end; flex-wrap: wrap; }

.input-group { flex: 1; min-width: 220px; }
.input-group input, .input-group textarea, .input-group select {
  width: 100%; padding: 10px; border: 2px solid var(--muted); border-radius: 8px;
  font-size: 14px; font-family: inherit; background: var(--bg-2); color: var(--text-0);
}
.input-group input::placeholder, .input-group textarea::placeholder { color: var(--placeholder); }
.input-group textarea { resize: vertical; min-height: 40px; }

.btn {
  padding: 10px 12px; border: 1px solid transparent; border-radius: 8px; font-size: 14px; font-weight: 500;
  cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: all 0.15s ease;
  color: var(--text-0);
}
.btn-primary { background: var(--brand); border-color: var(--brand); color: #00110b; }
.btn-primary:hover { background: var(--brand-2); border-color: var(--brand-2); color: #00110b; }
.btn-primary:disabled { background: #1f3b31; border-color: #1f3b31; color: #0a1f1a; cursor: not-allowed; }

.btn-secondary { background: var(--bg-2); color: var(--text-0); border-color: var(--muted); }
.btn-secondary:hover { background: #141c2c; border-color: var(--muted-2); }

.btn-danger { background: var(--danger-bg); color: var(--danger-text); border-color: var(--danger-border); }
.btn-danger:hover { background: #991b1b; }

.btn-mini { padding: 4px 8px; font-size: 12px; border-radius: 6px; }

.toolbar-row, .filter-row { display: flex; gap: 10px; align-items: center; justify-content: flex-start; margin-bottom: 10px; flex-wrap: wrap; }

.filter-group {
  display: flex; align-items: center; gap: 8px; background: var(--bg-2); border: 2px solid var(--muted); border-radius: 8px; padding: 8px 10px;
  color: var(--text-1); font-size: 13px;
}
.filter-group .checks { display: inline-flex; align-items: center; gap: 10px; }
.filter-group label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
.filter-group input[type="checkbox"] { accent-color: #10b981; }

.tag-chips { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; background: var(--bg-2); border: 2px solid var(--muted); border-radius: 8px; padding: 8px 10px; }
.tag-chip { font-size: 12px; padding: 6px 8px; border-radius: 999px; border: 1px solid #334155; color: var(--text-1); background: #0f172a; cursor: pointer; }
.tag-chip.active { background: rgba(16,185,129,.18); color: #a7f3d0; border-color: #10b981; }

.board-note { font-size: 12px; color: var(--text-2); background: #0f172a; border: 1px dashed var(--muted); padding: 6px 10px; border-radius: 8px; }
.board-note .link { color: #a7f3d0; text-decoration: underline; cursor: pointer; }

.board {
  position: relative; background: var(--bg-1); border: 2px dashed var(--muted); border-radius: 12px;
  height: 68vh; overflow: auto; box-shadow: 0 1px 3px rgba(0,0,0,0.3);
  z-index: 0;
}

.canvas { position: relative; min-height: 100%; min-width: 100%; }

.drop-indicator {
  position: absolute; height: 180px; border: 2px dashed var(--brand); border-radius: 10px;
  background: rgba(16,185,129,.06); box-shadow: inset 0 0 0 2px rgba(16,185,129,.05);
  pointer-events: none; transition: left 120ms ease, top 120ms ease, width 120ms ease, opacity 100ms ease;
  opacity: 0; z-index: 5;
}
.drop-indicator.show { opacity: 1; }

.empty-state {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  text-align: center; color: var(--text-2); pointer-events: none;
}
.empty-state .icon { font-size: 4rem; margin-bottom: 16px; }

.notecard {
  position: absolute; width: 260px; height: 180px;
  background: #ffffff; border: 2px solid #e2e8f0; border-radius: 10px;
  padding: 12px 12px 10px 12px; cursor: move; user-select: none; box-shadow: 0 10px 24px rgba(0,0,0,0.25);
  transition: left 120ms ease, top 120ms ease, width 120ms ease, transform 0.12s ease, box-shadow 0.12s ease, opacity 120ms ease;
  z-index: 10; color: #111827; overflow: hidden;
}
.notecard:hover { box-shadow: 0 14px 36px rgba(0,0,0,0.35); }
.notecard.dragging { transform: rotate(2deg) scale(1.05); z-index: 50; box-shadow: 0 20px 44px rgba(0,0,0,0.45); transition: none !important; cursor: grabbing; }
.body-dragging, .body-dragging * { user-select: none !important; cursor: grabbing !important; }
.notecard.disabled { cursor: default; opacity: .95; }
.notecard.dimmed { opacity: .35; filter: saturate(.75); }

.notecard.act { background: transparent; color: var(--text-0); border-color: var(--muted); height: 72px; box-shadow: none; cursor: default; }
.notecard.beat { background: #f8fafc; }
.notecard.beat .notecard-title { font-style: italic; }

.notecard-header { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 6px; }
.title-row { display: flex; gap: 6px; align-items: center; flex: 1; min-width: 0; }
.badge { font-size: 10px; color: #0b2a1f; background: #d1fae5; border: 1px solid #86efac; border-radius: 999px; padding: 3px 6px; text-transform: uppercase; letter-spacing: .3px; }
.badge.dark { background: #0f172a; color: var(--text-1); border-color: var(--muted); }

.notecard-title { font-weight: 700; color: #0f172a; font-size: 14px; flex: 1; margin-right: 8px; word-wrap: break-word; letter-spacing: .2px; line-height: 1.15; }
.notecard.act .notecard-title { color: var(--text-0); font-size: 16px; }

.notecard-actions { display: flex; gap: 4px; }
.icon-btn { width: 26px; height: 26px; border: none; background: none; cursor: pointer; border-radius: 6px; display: flex; align-items: center; justify-content: center; color: #475569; transition: all 0.15s; }
.icon-btn:hover { background: rgba(15, 23, 42, 0.06); }
.icon-btn.delete:hover { color: #dc2626; }
.icon-btn.disabled { opacity: .5; pointer-events: none; }

.meta-row { display: flex; gap: 8px; align-items: center; margin-bottom: 4px; }
.tiny { font-size: 11px; color: #475569; }
.tiny.dark { color: var(--text-2); }

.notecard-content { font-size: 13px; color: #334155; line-height: 1.35; white-space: pre-wrap; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; }
.content-line { white-space: pre-wrap; }
.content-line.marker-line { background: var(--marker-bg); border-left: 3px solid var(--marker-border); padding-left: 6px; border-radius: 4px; margin: 2px 0; }

.tags { margin-top: 6px; display: flex; gap: 6px; flex-wrap: wrap; }
.tag-pill { font-size: 10px; line-height: 1; padding: 5px 7px; border-radius: 999px; border: 1px solid #cbd5e1; color: #1f2937; background: #f1f5f9; }
.notecard.act .tag-pill { background: #0f172a; border-color: var(--muted); color: var(--text-1); }

.markers { margin-top: 6px; display: flex; gap: 6px; align-items: center; overflow-x: auto; padding-bottom: 2px; }
.marker-pill { font-size: 11px; line-height: 1; padding: 6px 8px; background: var(--marker-pill-bg); color: var(--marker-pill-text); border: 1px solid var(--marker-pill-border); border-radius: 999px; white-space: nowrap; flex: 0 0 auto; }

.tip { text-align: center; color: var(--text-2); font-size: 14px; margin-top: 10px; }

@media (max-width: 768px) {
  .controls { flex-direction: column; }
  .header { flex-direction: column; align-items: stretch; }
  .header-actions { justify-content: stretch; }
  .project-title { width: 100%; min-width: 0; }
  .btn { justify-content: center; }
}
</style>
</head>
<body>
<div class="container">
<div class="top-sticky">
  <div class="header">
    <div>
      <h1>Screenplay Notecard Board</h1>
      <p>Organize your acts, beats, scenes, characters, and notes</p>
    </div>
    <div class="header-actions">
      <input id="projectTitle" class="project-title" type="text" placeholder="Project Title (used in export)">
      <div class="cols-wrapper">
        <span>Cards/row</span>
        <input id="colsInput" class="cols-input" type="number" min="1" max="12" step="1" />
      </div>
      <button class="btn btn-secondary" id="helpBtn">‚ùì How to use</button>
    </div>
  </div>

  <div class="controls">
    <div class="type-wrapper">
      <span>Type</span>
      <select id="typeSelect" class="type-select">
        <option value="scene">Scene</option>
        <option value="beat">Beat</option>
        <option value="act">Act</option>
        <option value="character">Character</option>
        <option value="note">Note</option>
      </select>
    </div>
    <div class="input-group">
      <input type="text" id="titleInput" placeholder="Title (INT./EXT./I/E. auto-caps for Scenes)">
    </div>
    <div class="input-group">
      <textarea id="contentInput" placeholder="Content or notes... Start a line with '=' to track arcs/plot. Use @Tags anywhere (e.g., @B-Story, @Kayla)." rows="1"></textarea>
    </div>
    <button class="btn btn-primary" id="addBtn" disabled>‚ûï Add Card</button>
  </div>

  <div class="toolbar-row">
    <button class="btn btn-secondary" id="exportBtn" disabled>üì• Export .fountain</button>
    <button class="btn btn-secondary" id="saveBtn" title="Save to a .json file">üíæ Save Project</button>
    <button class="btn btn-secondary" id="openBtn" title="Open a saved project">üìÇ Open Project</button>
    <button class="btn btn-secondary" id="beatsheetBtn" title="Import beatsheet from .fountain">üéº Import Beatsheet</button>
    <button class="btn btn-danger" id="clearBtn" title="Clear all cards">üßπ New / Clear Board</button>
    <input type="file" id="openFile" accept=".json,application/json" style="display:none" />
    <input type="file" id="beatsheetFile" accept=".fountain,text/plain" style="display:none" />
  </div>

  <div class="filter-row">
    <div class="filter-group">
      <strong>Types:</strong>
      <div class="checks">
        <label><input type="checkbox" id="f-type-scene" checked> Scene</label>
        <label><input type="checkbox" id="f-type-beat" checked> Beat</label>
        <label><input type="checkbox" id="f-type-act" checked> Act</label>
        <label><input type="checkbox" id="f-type-character" checked> Character</label>
        <label><input type="checkbox" id="f-type-note" checked> Note</label>
      </div>
    </div>

    <div class="filter-group">
      <label for="actFilter"><strong>Act:</strong></label>
      <select id="actFilter" class="type-select" style="padding:6px 10px;">
        <option value="">All Acts</option>
      </select>
    </div>

    <div class="tag-chips" id="tagsBar">
      <strong style="color:var(--text-1);">Tags:</strong>
    </div>

    <button class="btn btn-secondary" id="clearFiltersBtn">‚úñ Clear filters</button>
    <span class="board-note" id="dragNote" style="display:none;">Reordering is disabled while filters are active. <span class="link" id="clearToReorder">Clear</span></span>
  </div>
</div>

<div class="board" id="board">
  <div class="canvas" id="canvas"></div>
  <div class="empty-state" id="emptyState">
    <div class="icon">üìù</div>
    <p style="font-size: 1.05rem; margin-bottom: 8px;">Create your first card to get started</p>
    <p style="font-size: 0.9rem;">Use Types for Act/Beat/Scene. Lines that start with "=" become arc chips. @Tags help organization.</p>
  </div>
</div>

<div class="tip">
  Tip: Acts create full-width dividers; Beats/Scenes snap to a grid. Drag to reorder. Save or export any time.
</div>
</div>

Edit Modal 
<div class="modal" id="editModal" aria-modal="true" role="dialog" aria-labelledby="editModalTitle">
<div class="modal-content">
  <div class="modal-header"><h3 id="editModalTitle">Edit Card</h3></div>
  <div class="modal-body">
    <label class="tiny dark">Type</label>
    <select id="editType">
      <option value="scene">Scene</option>
      <option value="beat">Beat</option>
      <option value="act">Act</option>
      <option value="character">Character</option>
      <option value="note">Note</option>
    </select>
    <input type="text" id="editTitle" placeholder="Title">
    <textarea id="editContent" placeholder="Content" rows="6"></textarea>
    <div id="characterArcRow" style="display:none;">
      <label class="tiny dark" for="editArcShape">Character Arc</label>
      <select id="editArcShape">
        <option value="">‚Äî</option>
        <option value="positive">Positive</option>
        <option value="flat">Flat</option>
        <option value="negative">Negative</option>
      </select>
    </div>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" id="saveEdit">Save Changes</button>
    <button class="btn btn-secondary" id="cancelEdit">Cancel</button>
  </div>
</div>
</div>

Help Modal 
<div class="modal" id="helpModal" aria-modal="true" role="dialog" aria-labelledby="helpTitle">
<div class="modal-content">
  <div class="modal-header"><h3 id="helpTitle">How to use this board</h3></div>
  <div class="modal-body">
    <ul class="help-list" style="line-height:1.6; color:var(--text-1); font-size:14px;">
      <li>1) Choose a Type (Act, Beat, Scene, Character, Note), add a Title and optional Content, then ‚ÄúAdd Card‚Äù.</li>
      <li>2) Acts create full-width dividers and separate rows. Beats and Scenes snap into a uniform grid.</li>
      <li>3) Drag cards to reorder; the dotted box shows where they‚Äôll snap.</li>
      <li>4) Start a content line with ‚Äú=‚Äù to mark arcs/plot points as chips.</li>
      <li>5) Use @Tags anywhere (e.g., @B-Story, @Kayla). Tags show as chips and can be filtered above.</li>
      <li>6) Import beatsheets (.fountain): ‚Äú#‚Äù becomes Act, ‚Äú##‚Äù Beat, ‚Äú###‚Äù Scene. Export to .fountain anytime.</li>
      <li>7) Save/Open JSON files to keep multiple projects. ‚ÄúNew / Clear Board‚Äù resets the board.</li>
    </ul>
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary" id="closeHelp">Got it</button>
  </div>
</div>
</div>

Color Picker 
<div class="color-picker" id="colorPicker" style="position:absolute; background: var(--bg-3); border: 1px solid var(--muted); border-radius: 10px; padding: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.4); z-index: 250; display: none;">
<div class="color-picker-label" style="font-size: 12px; color: var(--text-1); margin-bottom: 6px;">Card color</div>
<div class="color-option white"  data-color="white" title="White" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#fff;border:2px solid #e2e8f0;display:inline-block;cursor:pointer;"></div>
<div class="color-option yellow" data-color="yellow" title="Yellow" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#fef3c7;display:inline-block;cursor:pointer;"></div>
<div class="color-option blue"   data-color="blue" title="Blue" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#dbeafe;display:inline-block;cursor:pointer;"></div>
<div class="color-option green"  data-color="green" title="Green" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#d1fae5;display:inline-block;cursor:pointer;"></div>
<div class="color-option pink"   data-color="pink" title="Pink" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#fce7f3;display:inline-block;cursor:pointer;"></div>
<div class="color-option purple" data-color="purple" title="Purple" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#e9d5ff;display:inline-block;cursor:pointer;"></div>
<div class="color-option orange" data-color="orange" title="Orange" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#fed7aa;display:inline-block;cursor:pointer;"></div>
<div class="color-option red"    data-color="red" title="Red" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#fecaca;display:inline-block;cursor:pointer;"></div>
<div class="color-option teal"   data-color="teal" title="Teal" style="width:24px;height:24px;border-radius:6px;margin:3px;background:#ccfbf1;display:inline-block;cursor:pointer;"></div>
</div>

<script>
class NotecardBoard {
  constructor() {
    // Grid
    this.padding = 24; this.gapX = 24; this.gapY = 24;
    this.cardW = 260; this.cardH = 180; this.actH = 72;

    // State
    this.notecards = []; this.cols = 4;
    this.layoutSlots = []; this.viewCards = []; this.viewIndexMap = [];

    // Drag
    this.draggedId = null; this.dragFromIndex = null;
    this.dragOffset = { x:0, y:0 }; this.dragTargetIndex = null;
    this.onDocMove = null; this.onDocUp = null;
    this.rafMove = null; this.lastMouse = { clientX: 0, clientY: 0 };

    // Filters
    this.filter = {
      types: { scene:true, beat:true, act:true, character:true, note:true },
      tags: new Set(),
      actId: ""
    };

    // Elements
    this.initElements();
    this.bindEvents();
    this.loadFromStorage();
    this.updateUI();
  }

  initElements() {
    this.board = document.getElementById('board');
    this.canvas = document.getElementById('canvas');

    // Creation
    this.titleInput = document.getElementById('titleInput');
    this.contentInput = document.getElementById('contentInput');
    this.addBtn = document.getElementById('addBtn');
    this.typeSelect = document.getElementById('typeSelect');

    // File/toolbar
    this.exportBtn = document.getElementById('exportBtn');
    this.saveBtn = document.getElementById('saveBtn');
    this.openBtn = document.getElementById('openBtn');
    this.beatsheetBtn = document.getElementById('beatsheetBtn');
    this.openFileInput = document.getElementById('openFile');
    this.beatsheetFileInput = document.getElementById('beatsheetFile');
    this.clearBtn = document.getElementById('clearBtn');

    // Empty state
    this.emptyState = document.getElementById('emptyState');

    // Modals
    this.editModal = document.getElementById('editModal');
    this.editType = document.getElementById('editType');
    this.editTitle = document.getElementById('editTitle');
    this.editContent = document.getElementById('editContent');
    this.characterArcRow = document.getElementById('characterArcRow');
    this.editArcShape = document.getElementById('editArcShape');

    this.helpBtn = document.getElementById('helpBtn');
    this.helpModal = document.getElementById('helpModal');
    this.closeHelp = document.getElementById('closeHelp');

    this.colorPicker = document.getElementById('colorPicker');
    this.projectTitleInput = document.getElementById('projectTitle');
    this.colsInput = document.getElementById('colsInput');

    // Filters UI
    this.fTypeScene = document.getElementById('f-type-scene');
    this.fTypeBeat = document.getElementById('f-type-beat');
    this.fTypeAct = document.getElementById('f-type-act');
    this.fTypeCharacter = document.getElementById('f-type-character');
    this.fTypeNote = document.getElementById('f-type-note');
    this.actFilter = document.getElementById('actFilter');
    this.tagsBar = document.getElementById('tagsBar');
    this.clearFiltersBtn = document.getElementById('clearFiltersBtn');
    this.dragNote = document.getElementById('dragNote');
    this.clearToReorder = document.getElementById('clearToReorder');

    // Drop indicator
    this.dropIndicator = document.createElement('div');
    this.dropIndicator.className = 'drop-indicator';
    this.canvas.appendChild(this.dropIndicator);
  }

  bindEvents() {
    // Columns
    this.colsInput.value = String(this.cols);
    this.colsInput.addEventListener('input', () => {
      const v = Math.max(1, Math.min(12, parseInt(this.colsInput.value || '4', 10)));
      this.cols = isNaN(v) ? 4 : v;
      this.colsInput.value = String(this.cols);
      this.saveCols(); this.updateUI();
    });

    // Title input
    this.titleInput.addEventListener('input', () => {
      let v = this.titleInput.value;
      if (this.typeSelect.value === 'scene') {
        const formatted = this.formatTitle(v);
        if (formatted !== v) {
          const pos = this.titleInput.selectionStart;
          this.titleInput.value = formatted; try { this.titleInput.setSelectionRange(pos, pos); } catch {}
        }
      }
      this.updateAddButton();
    });
    this.titleInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.createNotecard(); });
    this.typeSelect.addEventListener('change', () => this.updateAddButton());

    // Buttons
    this.addBtn.addEventListener('click', () => this.createNotecard());
    this.exportBtn.addEventListener('click', () => this.exportToFountain());
    this.saveBtn.addEventListener('click', () => this.saveProjectToFile());
    this.openBtn.addEventListener('click', () => this.openFileInput.click());
    this.beatsheetBtn.addEventListener('click', () => this.beatsheetFileInput.click());
    this.openFileInput.addEventListener('change', (e) => this.openProjectFile(e));
    this.beatsheetFileInput.addEventListener('change', (e) => this.importBeatsheetFile(e));
    this.clearBtn.addEventListener('click', () => this.clearBoard());

    // ESC key
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (this.editModal.classList.contains('show')) { this.closeEditModal(); return; }
        if (this.helpModal.classList.contains('show')) { this.helpModal.classList.remove('show'); return; }
      }
    });

    // Help modal
    this.helpBtn.addEventListener('click', () => this.helpModal.classList.add('show'));
    this.closeHelp.addEventListener('click', () => this.helpModal.classList.remove('show'));
    this.helpModal.addEventListener('click', (e) => { if (e.target === this.helpModal) this.helpModal.classList.remove('show'); });

    // Edit modal
    document.getElementById('saveEdit').addEventListener('click', () => this.saveEdit());
    document.getElementById('cancelEdit').addEventListener('click', () => this.closeEditModal());
    this.editModal.addEventListener('click', (e) => { if (e.target === this.editModal) this.closeEditModal(); });
    this.editType.addEventListener('change', () => {
      this.characterArcRow.style.display = this.editType.value === 'character' ? 'block' : 'none';
    });

    // Color picker
    document.querySelectorAll('.color-option').forEach(option => {
      option.addEventListener('click', (e) => {
        const color = e.target.dataset.color;
        if (this.colorPickerCard) { this.changeCardColor(this.colorPickerCard, color); this.hideColorPicker(); }
      });
    });
    document.addEventListener('click', (e) => {
      if (!this.colorPicker.contains(e.target) && !e.target.closest('.icon-btn')) this.hideColorPicker();
    });

    // Project title persistence
    this.projectTitleInput.addEventListener('input', () => this.saveProjectTitle());

    // Filters
    [
      {el:this.fTypeScene, key:'scene'},
      {el:this.fTypeBeat, key:'beat'},
      {el:this.fTypeAct, key:'act'},
      {el:this.fTypeCharacter, key:'character'},
      {el:this.fTypeNote, key:'note'},
    ].forEach(({el, key}) => {
      el.addEventListener('change', () => { this.filter.types[key] = el.checked; this.updateUI(); });
    });
    this.actFilter.addEventListener('change', () => { this.filter.actId = this.actFilter.value || ''; this.updateUI(); });
    this.clearFiltersBtn.addEventListener('click', () => {
      this.filter.types = { scene:true, beat:true, act:true, character:true, note:true };
      this.filter.tags.clear(); this.filter.actId = '';
      this.fTypeScene.checked = this.fTypeBeat.checked = this.fTypeAct.checked = this.fTypeCharacter.checked = this.fTypeNote.checked = true;
      this.actFilter.value = '';
      this.updateUI();
    });
    this.clearToReorder.addEventListener('click', () => {
      this.clearFiltersBtn.click();
    });

    // Tag chips built dynamically
  }

  // Title normalization
  formatTitle(title) {
    const lower = title.toLowerCase();
    if (lower.startsWith('int.') || lower.startsWith('ext.') || lower.startsWith('i/e.')) return title.toUpperCase();
    return title;
  }
  updateAddButton() { this.addBtn.disabled = !(this.titleInput.value.trim().length > 0); }

  // Cards
  createNotecard() {
    const rawTitle = this.titleInput.value.trim(); if (!rawTitle) return;
    const type = this.typeSelect.value; const title = type === 'scene' ? this.formatTitle(rawTitle) : rawTitle;
    const card = { id: Date.now().toString(), type, title, content: this.contentInput.value, color: type==='scene'?'white':(type==='beat'?'yellow':(type==='character'?'blue':'white')), tags: [], meta: {} };
    this.notecards.push(card); this.titleInput.value = ''; this.contentInput.value = ''; this.updateAddButton(); this.saveToStorage(); this.updateUI();
  }
  deleteNotecard(id) {
    this.notecards = this.notecards.filter(card => card.id !== id);
    this.saveToStorage(); this.updateUI();
  }
  changeCardColor(id, color) {
    const card = this.notecards.find(c => c.id === id); if (card) { card.color = color; this.saveToStorage(); this.updateUI(); }
  }
  showEditModal(card) {
    this.editingCard = card; this.editType.value = card.type || 'scene'; this.editTitle.value = card.title || ''; this.editContent.value = card.content || '';
    this.editArcShape.value = (card.meta && card.meta.arcShape) || ''; this.characterArcRow.style.display = (card.type === 'character') ? 'block' : 'none';
    this.editModal.classList.add('show');
  }
  closeEditModal() { this.editModal.classList.remove('show'); this.editingCard = null; }
  saveEdit() {
    if (!this.editingCard) return;
    const newType = this.editType.value; this.editingCard.type = newType;
    this.editingCard.title = (newType === 'scene') ? this.formatTitle(this.editTitle.value) : this.editTitle.value;
    this.editingCard.content = this.editContent.value;
    this.editingCard.meta = this.editingCard.meta || {}; this.editingCard.meta.arcShape = (newType === 'character') ? (this.editArcShape.value || '') : '';
    if (newType === 'act') this.editingCard.color = 'white';
    this.saveToStorage(); this.updateUI(); this.closeEditModal();
  }

  // Color picker
  showColorPicker(cardId, buttonElement) {
    this.colorPickerCard = cardId; const rect = buttonElement.getBoundingClientRect();
    this.colorPicker.style.left = rect.left + 'px'; this.colorPicker.style.top = (rect.bottom + 5) + 'px'; this.colorPicker.style.display = 'block';
  }
  hideColorPicker() { this.colorPicker.style.display = 'none'; this.colorPickerCard = null; }

  // Dragging (requestAnimationFrame-optimized)
  startDrag(e, cardId) {
    e.preventDefault();
    const cardEl = this.canvas.querySelector(`[data-id="${cardId}"]`);
    if (!cardEl) return;
    const rect = cardEl.getBoundingClientRect();

    this.draggedId = cardId;
    this.dragFromIndex = this.notecards.findIndex(c => c.id === cardId);
    this.dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
    cardEl.classList.add('dragging');
    cardEl.style.transition = 'none';
    document.body.classList.add('body-dragging');

    this.ensureLayoutSlots(this.notecards);
    const fromSlot = this.layoutSlots[this.dragFromIndex];
    if (fromSlot) {
      this.dropIndicator.style.left = fromSlot.left + 'px';
      this.dropIndicator.style.top = fromSlot.top + 'px';
      this.dropIndicator.style.width = fromSlot.width + 'px';
      this.dropIndicator.classList.add('show');
    }

    this.onDocMove = (ev) => this.handleMouseMove(ev);
    this.onDocUp = () => this.handleMouseUp();
    document.addEventListener('mousemove', this.onDocMove);
    document.addEventListener('mouseup', this.onDocUp);
  }
  handleMouseDown(e, cardId) {
    const card = this.notecards.find(c => c.id === cardId);
    if (!card || card.type === 'act') return;
    if (this.hasActiveFilters()) return;
    if (!e.target.closest('.icon-btn')) this.startDrag(e, cardId);
  }
  handleMouseMove(e) {
    if (!this.draggedId) return;
    this.lastMouse = { clientX: e.clientX, clientY: e.clientY };
    if (this.rafMove) return;
    this.rafMove = requestAnimationFrame(() => {
      this.rafMove = null;
      this.processDrag(this.lastMouse.clientX, this.lastMouse.clientY);
    });
  }
  processDrag(clientX, clientY) {
    const cardEl = this.canvas.querySelector(`[data-id="${this.draggedId}"]`);
    if (!cardEl) return;

    const boardRect = this.board.getBoundingClientRect();
    const x = clientX - boardRect.left + this.board.scrollLeft - this.dragOffset.x;
    const y = clientY - boardRect.top + this.board.scrollTop - this.dragOffset.y;

    const maxX = Math.max(0, (this.canvas.scrollWidth || this.canvas.clientWidth) - this.cardW);
    const maxY = Math.max(0, (this.canvas.scrollHeight || this.canvas.clientHeight) - this.cardH);
    const clampedX = Math.max(0, Math.min(x, maxX));
    const clampedY = Math.max(0, Math.min(y, maxY));

    cardEl.style.left = clampedX + 'px';
    cardEl.style.top = clampedY + 'px';

    const target = this.nearestDroppableSlotIndex(clientX, clientY);
    this.dragTargetIndex = target;

    const targetPos = this.layoutSlots[target];
    if (targetPos) {
      this.dropIndicator.style.left = targetPos.left + 'px';
      this.dropIndicator.style.top = targetPos.top + 'px';
      this.dropIndicator.style.width = targetPos.width + 'px';
    }

    this.layoutDuringDrag();
  }
  handleMouseUp() {
    if (!this.draggedId) return;
    const fromIndex = this.dragFromIndex;
    let toIndex = this.dragTargetIndex;
    if (typeof toIndex !== 'number') toIndex = fromIndex;
    toIndex = Math.max(0, Math.min(this.notecards.length - 1, toIndex));
    if (fromIndex !== -1 && toIndex !== fromIndex) {
      const [moved] = this.notecards.splice(fromIndex, 1);
      this.notecards.splice(toIndex, 0, moved);
      this.saveToStorage();
    }
    const cardEl = this.canvas.querySelector(`[data-id="${this.draggedId}"]`);
    if (cardEl) {
      cardEl.classList.remove('dragging');
      cardEl.style.transition = '';
    }
    document.body.classList.remove('body-dragging');

    if (this.rafMove) { cancelAnimationFrame(this.rafMove); this.rafMove = null; }

    this.draggedId = null; this.dragFromIndex = null; this.dragTargetIndex = null;
    this.dropIndicator.classList.remove('show');
    if (this.onDocMove) document.removeEventListener('mousemove', this.onDocMove);
    if (this.onDocUp) document.removeEventListener('mouseup', this.onDocUp);
    this.onDocMove = this.onDocUp = null;
    this.updateUI();
  }
  layoutDuringDrag() {
    const from = this.dragFromIndex;
    const to = this.dragTargetIndex;
    if (from == null || to == null) return;
    this.ensureLayoutSlots(this.notecards);
    this.notecards.forEach((card, i) => {
      if (i === from) return;
      let displayIndex = i;
      if (to > from) { if (i > from && i <= to) displayIndex = i - 1; }
      else if (to < from) { if (i >= to && i < from) displayIndex = i + 1; }
      const el = this.canvas.querySelector(`[data-id="${card.id}"]`);
      const slot = this.layoutSlots[displayIndex];
      if (el && slot) {
        el.style.left = slot.left + 'px';
        el.style.top = slot.top + 'px';
        if (card.type === 'act') el.style.width = slot.width + 'px';
      }
    });
  }

  ensureLayoutSlots(cards) {
    const slots = [];
    let row = 0, col = 0;
    const fullRowWidth = this.padding * 2 + this.cols * this.cardW + (this.cols - 1) * this.gapX;

    for (let i = 0; i < cards.length; i++) {
      const c = cards[i];
      if (c.type === 'act') {
        if (col !== 0) { row += 1; col = 0; }
        const left = this.padding;
        const top = this.padding + row * (this.cardH + this.gapY);
        slots.push({ left, top, width: fullRowWidth - this.padding*2, isAct: true, centerX: left + (fullRowWidth - this.padding*2)/2, centerY: top + this.actH/2 });
        row += 1; col = 0;
      } else {
        const left = this.padding + col * (this.cardW + this.gapX);
        const top = this.padding + row * (this.cardH + this.gapY);
        slots.push({ left, top, width: this.cardW, isAct: false, centerX: left + this.cardW/2, centerY: top + this.cardH/2 });
        col += 1;
        if (col >= this.cols) { col = 0; row += 1; }
      }
    }
    this.layoutSlots = slots;

    const totalRows = this.computeTotalRows(cards);
    const width = fullRowWidth;
    const height = this.padding * 2 + totalRows * this.cardH + (totalRows - 1) * this.gapY;
    this.canvas.style.width = width + 'px'; this.canvas.style.height = height + 'px';
  }
  computeTotalRows(cards) {
    let rows = 0, col = 0;
    for (const c of cards) {
      if (c.type === 'act') { if (col !== 0) { rows += 1; col = 0; } rows += 1; col = 0; }
      else { col += 1; if (col >= this.cols) { rows += 1; col = 0; } }
    }
    if (col > 0) rows += 1;
    if (rows === 0) rows = 1;
    return rows;
  }
  nearestDroppableSlotIndex(clientX, clientY) {
    if (!this.layoutSlots.length) return 0;
    const rect = this.board.getBoundingClientRect();
    const px = clientX - rect.left + this.board.scrollLeft;
    const py = clientY - rect.top + this.board.scrollTop;
    let best = -1, bestD = Infinity;
    for (let i = 0; i < this.layoutSlots.length; i++) {
      const slot = this.layoutSlots[i];
      if (slot.isAct) continue;
      const dx = slot.centerX - px; const dy = slot.centerY - py;
      const d = dx*dx + dy*dy;
      if (d < bestD) { bestD = d; best = i; }
    }
    if (best === -1) best = 0; return best;
  }

  // Export/Save/Open/Import
  exportToFountain() {
    let content = '';
    const projectTitle = (this.projectTitleInput.value || '').trim();
    if (projectTitle) content += 'Title: ' + projectTitle + '\n';
    content += 'Draft date: ' + new Date().toLocaleDateString() + '\n\n';
    this.notecards.forEach(card => {
      if (card.type === 'act') {
        content += '# ' + (card.title || 'ACT') + '\n\n';
      } else if (card.type === 'beat') {
        content += '## ' + (card.title || 'Beat') + '\n\n';
        if (card.content) content += card.content + '\n\n';
      } else {
        content += (card.title || 'Untitled') + '\n\n';
        if (card.content) content += card.content + '\n';
        content += '\n';
      }
    });
    const blob = new Blob([content], { type: 'text/plain' }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = (projectTitle ? this.sanitizeFilename(projectTitle) : 'screenplay-notes') + '.fountain';
    a.click(); URL.revokeObjectURL(url);
  }
  saveProjectToFile() {
    const project = { version: 21, projectTitle: this.projectTitleInput.value || '', cols: this.cols, notecards: this.notecards, savedAt: new Date().toISOString() };
    const json = JSON.stringify(project, null, 2); const blob = new Blob([json], { type: 'application/json' });
    const url = URL.createObjectURL(blob); const a = document.createElement('a');
    const name = (project.projectTitle ? this.sanitizeFilename(project.projectTitle) : 'notecard-board') + '.json';
    a.href = url; a.download = name; a.click(); URL.revokeObjectURL(url);
  }
  openProjectFile(e) {
    const file = e.target.files && e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (!data || !Array.isArray(data.notecards)) throw new Error('Invalid file format');
        this.projectTitleInput.value = data.projectTitle || '';
        this.cols = Number.isFinite(data.cols) && data.cols >= 1 ? data.cols : (this.cols || 4); this.colsInput.value = String(this.cols);
        // Drop any legacy link/throughline data; only map core fields
        this.notecards = data.notecards.map(c => ({
          id: String(c.id || Date.now() + Math.random()),
          type: ['scene','beat','act','character','note'].includes(c.type) ? c.type : 'scene',
          title: typeof c.title === 'string' ? c.title : '',
          content: typeof c.content === 'string' ? c.content : '',
          color: ['white','yellow','blue','green','pink','purple','orange','red','teal'].includes(c.color) ? c.color : 'white',
          tags: Array.isArray(c.tags) ? c.tags : [],
          meta: c.meta && typeof c.meta === 'object' ? c.meta : {}
        }));
        this.saveToStorage(); this.updateUI();
      } catch (err) {
        alert('Could not open project. Make sure you selected a valid project JSON file.');
        console.error('Open project error:', err);
      } finally { e.target.value = ''; }
    };
    reader.onerror = () => { alert('Failed to read the selected file.'); e.target.value = ''; };
    reader.readAsText(file);
  }
  importBeatsheetFile(e) {
    const file = e.target.files && e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try {
        const text = String(reader.result || ''); const newCards = this.parseBeatsheet(text);
        if (newCards.length === 0) { alert('No headings (#) found in this Fountain file.'); return; }
        const clear = confirm('Clear existing cards before importing?\nOK = Clear and import\nCancel = Append to current board');
        if (clear) this.notecards = [];
        newCards.forEach((c) => {
          this.notecards.push({ id: (Date.now() + Math.random()).toString(), type: c.type, title: c.type === 'scene' ? this.formatTitle(c.title) : c.title, content: c.content, color: 'white', tags: [], meta: {} });
        });
        this.saveToStorage(); this.updateUI();
      } catch (err) {
        alert('Could not import beatsheet. Make sure you selected a valid Fountain (.fountain) file.');
        console.error('Beatsheet import error:', err);
      } finally { e.target.value = ''; }
    };
    reader.onerror = () => { alert('Failed to read the selected file.'); e.target.value = ''; };
    reader.readAsText(file);
  }
  parseBeatsheet(text) {
    const lines = text.replace(/\r\n?/g, '\n').split('\n'); const cards = []; let curr = null;
    const push = () => { if (!curr) return; const content = curr.lines.join('\n').trim(); cards.push({ type: curr.type, title: curr.title.trim(), content }); };
    for (const raw of lines) {
      const m = raw.match(/^(\s*#{1,6})\s*(.+?)\s*$/);
      if (m) { push(); const level = m[1].trim().length; const title = m[2]; let type = 'scene'; if (level === 1) type = 'act'; else if (level === 2) type = 'beat'; curr = { type, title, lines: [] }; }
      else { if (!curr) continue; curr.lines.push(raw); }
    }
    push(); return cards;
  }

  extractMarkers(text) { if (!text) return []; return text.split(/\r?\n/).filter(l => l.trim().startsWith('=')).map(l => l.replace(/^=\s*/, '').trim()).filter(Boolean); }
  extractTags(text) { if (!text) return []; const tags = new Set(); const re = /@([A-Za-z0-9_\-]+)/g; let m; while ((m = re.exec(text)) !== null) tags.add('@' + m[1]); return Array.from(tags); }
  renderContentHTML(text) {
    if (!text) return '';
    return text.split(/\r?\n/).map(line => {
      const isMarker = line.trim().startsWith('=');
      const safe = this.escapeHtml(line.replace(/^=\s*/, '= '));
      return `<div class="content-line${isMarker ? ' marker-line' : ''}">${safe}</div>`;
    }).join('');
  }

  // Filters
  hasActiveFilters() {
    const allTypes = this.filter.types.scene && this.filter.types.beat && this.filter.types.act && this.filter.types.character && this.filter.types.note;
    return !allTypes || this.filter.tags.size > 0 || !!this.filter.actId;
  }
  buildActOptions() {
    const prev = this.actFilter.value;
    this.actFilter.innerHTML = '<option value="">All Acts</option>';
    this.notecards.forEach(c => { if (c.type === 'act') { const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.title || 'ACT'; this.actFilter.appendChild(opt); } });
    const exists = Array.from(this.actFilter.options).some(o => o.value === prev);
    this.actFilter.value = exists ? prev : '';
    if (!exists) this.filter.actId = '';
  }
  getAllTags() {
    const set = new Set();
    this.notecards.forEach(c => { (c.tags || []).forEach(t => set.add(t)); this.extractTags(c.content).forEach(t => set.add(t)); });
    return Array.from(set).sort((a,b)=>a.localeCompare(b));
  }
  buildTagChips() {
    const all = this.getAllTags();
    this.tagsBar.querySelectorAll('.tag-chip').forEach(el => el.remove());
    all.forEach(tag => {
      const chip = document.createElement('span');
      chip.className = 'tag-chip' + (this.filter.tags.has(tag) ? ' active' : '');
      chip.textContent = tag;
      chip.addEventListener('click', () => { if (this.filter.tags.has(tag)) this.filter.tags.delete(tag); else this.filter.tags.add(tag); this.updateUI(); });
      this.tagsBar.appendChild(chip);
    });
  }

  computeActRanges() {
    const ranges = []; let currentActId = null;
    for (let i=0;i<this.notecards.length;i++) {
      const c = this.notecards[i];
      if (c.type === 'act') {
        if (currentActId !== null) ranges[ranges.length-1].end = i;
        currentActId = c.id; ranges.push({ id: c.id, title: c.title || 'ACT', start: i, end: this.notecards.length });
      }
    }
    if (ranges.length) ranges[ranges.length-1].end = this.notecards.length;
    return ranges;
  }

  // UI
  updateUI() {
    // Filters UI
    this.buildActOptions();
    this.buildTagChips();

    // Build view and slots
    this.buildView();
    const cardsForLayout = (this.draggedId ? this.notecards : this.viewCards);
    this.ensureLayoutSlots(cardsForLayout);

    const draggingDisabled = this.hasActiveFilters();
    this.dragNote.style.display = draggingDisabled ? 'inline-block' : 'none';

    // Clear and render cards
    this.canvas.querySelectorAll('.notecard').forEach(card => card.remove());

    const anyCards = this.notecards.length > 0;
    this.emptyState.style.display = anyCards ? 'none' : 'block';
    this.exportBtn.disabled = !anyCards;

    const renderCards = (this.draggedId ? this.notecards : this.viewCards);
    renderCards.forEach((card, i) => {
      const slot = this.layoutSlots[i];
      const el = this.createCardElement(card, draggingDisabled);
      el.style.left = slot.left + 'px'; el.style.top = slot.top + 'px';
      if (card.type === 'act') el.style.width = slot.width + 'px';
      this.canvas.appendChild(el);
    });
  }

  buildView() {
    let start = 0, end = this.notecards.length;
    const actRanges = this.computeActRanges();
    if (this.filter.actId) {
      const r = actRanges.find(r => r.id === this.filter.actId);
      if (r) { start = r.start; end = r.end; }
    }

    const viewCards = []; const map = [];
    for (let i = start; i < end; i++) {
      const c = this.notecards[i];

      if (this.filter.actId && c.type === 'act' && c.id === this.filter.actId) { viewCards.push(c); map.push(i); continue; }

      if (!this.filter.types[c.type]) continue;

      if (this.filter.tags.size > 0) {
        const tags = new Set([...(c.tags || []), ...this.extractTags(c.content)]);
        let ok = false; for (const t of this.filter.tags) if (tags.has(t)) { ok = true; break; }
        if (!ok) continue;
      }

      viewCards.push(c); map.push(i);
    }

    if (this.filter.actId) {
      const actIndex = this.notecards.findIndex(c => c.id === this.filter.actId);
      const actCard = this.notecards[actIndex];
      if (actCard && !viewCards.includes(actCard)) { viewCards.unshift(actCard); map.unshift(actIndex); }
    }

    this.viewCards = viewCards; this.viewIndexMap = map;
  }

  createCardElement(card, draggingDisabled) {
    const div = document.createElement('div'); div.className = `notecard color-${card.color} ${card.type}`; div.dataset.id = card.id;

    const markers = this.extractMarkers(card.content);
    const tags = Array.from(new Set([...(card.tags || []), ...this.extractTags(card.content)]));

    const contentHTML = this.renderContentHTML(card.content);

    const typeBadge = card.type === 'act' ? '<span class="badge dark">Act</span>' :
                      card.type === 'beat' ? '<span class="badge">Beat</span>' :
                      card.type === 'character' ? '<span class="badge">Character</span>' :
                      card.type === 'note' ? '<span class="badge">Note</span>' :
                      '<span class="badge">Scene</span>';

    div.innerHTML = `
      <div class="notecard-header">
        <div class="title-row">
          ${typeBadge}
          <div class="notecard-title">${this.escapeHtml(card.title)}</div>
        </div>
        <div class="notecard-actions">
          <button class="icon-btn palette-btn ${card.type==='act' ? 'disabled':''}" title="Change color">üé®</button>
          <button class="icon-btn edit-btn" title="Edit">‚úèÔ∏è</button>
          <button class="icon-btn delete" title="Delete">‚ùå</button>
        </div>
      </div>
      ${card.type !== 'act' ? `<div class="notecard-content">${contentHTML}</div>` : `<div class="meta-row"><span class="tiny dark">Act Divider</span></div>`}
      ${tags.length ? `<div class="tags">${tags.map(t => `<span class="tag-pill">${this.escapeHtml(t)}</span>`).join('')}</div>` : ''}
      ${markers.length ? `<div class="markers">${markers.map(m => `<span class="marker-pill">${this.escapeHtml(m)}</span>`).join('')}</div>` : ''}
    `;

    // Dragging
    if (card.type !== 'act' && !draggingDisabled) {
      div.addEventListener('mousedown', (e) => {
        if (!e.target.closest('.icon-btn')) this.handleMouseDown(e, card.id);
      });
    } else { div.classList.add('disabled'); }

    // palette/edit/delete
    const paletteBtn = div.querySelector('.palette-btn');
    if (paletteBtn && card.type !== 'act') paletteBtn.addEventListener('click', (e) => { e.stopPropagation(); this.showColorPicker(card.id, e.target); });
    div.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); this.showEditModal(card); });
    div.querySelector('.delete').addEventListener('click', (e) => { e.stopPropagation(); this.deleteNotecard(card.id); });

    return div;
  }

  // Clear
  clearBoard() {
    const confirmed = confirm('This will clear all cards and the current title. Continue?');
    if (!confirmed) return;
    this.notecards = []; this.projectTitleInput.value = '';
    this.saveToStorage(); this.updateUI();
  }

  // Storage
  saveProjectTitle() { localStorage.setItem('screenplay-project-title', this.projectTitleInput.value || ''); }
  saveCols() { localStorage.setItem('screenplay-cols', String(this.cols)); }
  saveToStorage() {
    localStorage.setItem('screenplay-notecards', JSON.stringify(this.notecards));
    this.saveProjectTitle(); this.saveCols();
  }
  loadFromStorage() {
    const savedCards = localStorage.getItem('screenplay-notecards'); if (savedCards) { try { this.notecards = JSON.parse(savedCards) || []; } catch (e) { console.error('Load cards error:', e); } }
    const savedTitle = localStorage.getItem('screenplay-project-title'); if (savedTitle !== null) this.projectTitleInput.value = savedTitle;
    const savedCols = localStorage.getItem('screenplay-cols'); if (savedCols) { const n = parseInt(savedCols, 10); if (Number.isFinite(n) && n >= 1) this.cols = n; }
    this.colsInput.value = String(this.cols);
  }

  // Utils
  sanitizeFilename(name) { return String(name).replace(/[\\/:*?"<>|]/g, '_').trim() || 'project'; }
  escapeHtml(text) { const div = document.createElement('div'); div.textContent = text ?? ''; return div.innerHTML; }
}

document.addEventListener('DOMContentLoaded', () => { new NotecardBoard(); });
</script>
</body>
</html>
